# Marketplace Analytics Platform - Multi-Database Makefile
# ========================================================
# Supports three-database architecture:
# - ecommerce_db: B2C platforms (Uzum, Yandex)
# - classifieds_db: C2C platforms (OLX)
# - procurement_db: B2B platforms (UZEX)

.PHONY: help up down restart logs db-shell api worker beat flower \
        migrate migrate-all migrate-status create-schemas dump dump-all restore \
        counts uzum-download uzex-download test clean init-db db-status

# Default target
help:
	@echo "Marketplace Analytics Platform - Multi-Database Architecture"
	@echo "============================================================="
	@echo ""
	@echo "ðŸš€ Docker Commands:"
	@echo "  make up              - Start all services"
	@echo "  make down            - Stop all services"
	@echo "  make restart         - Restart all services"
	@echo "  make logs            - View logs (tail -f)"
	@echo "  make infra           - Start only PostgreSQL & Redis"
	@echo ""
	@echo "ðŸ—„ï¸ Database Management:"
	@echo "  make init-db         - Initialize all databases (create + migrate + setup)"
	@echo "  make create-schemas  - Create database schemas manually"
	@echo "  make db-status       - Show status of all databases"
	@echo "  make db-shell DB=ecommerce - PostgreSQL shell for specific database"
	@echo "  make counts          - Show table row counts for all databases"
	@echo ""
	@echo "ðŸ“ Migrations (Alembic):"
	@echo "  make migrate-all     - Run migrations for all databases"
	@echo "  make migrate DB=ecommerce - Migrate specific database"
	@echo "  make migrate-status  - Show migration status for all databases"
	@echo "  make revision DB=ecommerce MSG='Add indexes' - Create new migration"
	@echo ""
	@echo "ðŸ’¾ Backup & Restore:"
	@echo "  make dump-all        - Backup all databases"
	@echo "  make dump DB=ecommerce - Backup specific database"
	@echo "  make restore DB=ecommerce FILE=backup.sql - Restore database"
	@echo "  make restore-all TIMESTAMP=20241208_120000 - Restore all from backup set"
	@echo ""
	@echo "ðŸ”§ Services:"
	@echo "  make api             - Start FastAPI only"
	@echo "  make worker          - Start Celery worker"
	@echo "  make beat            - Start Celery beat scheduler"
	@echo "  make flower          - Start Flower (monitoring)"
	@echo ""
	@echo "ðŸ“Š Scrapers:"
	@echo "  make uzum-download N=1000    - Download N Uzum products"
	@echo "  make uzex-download N=100     - Download N UZEX lots"
	@echo "  make continuous-uzum         - Start continuous Uzum scraping"
	@echo "  make continuous-uzex         - Start continuous UZEX scraping"
	@echo ""
	@echo "ðŸ§ª Development:"
	@echo "  make test            - Run tests"
	@echo "  make clean           - Remove temp files"
	@echo "  make lint            - Run code linting"
	@echo ""
	@echo "Database Options: ecommerce, classifieds, procurement, legacy"

# =============================================================================
# Docker Commands
# =============================================================================

up:
	@echo "ðŸš€ Starting all services..."
	docker-compose up -d
	@echo "âœ… Services started"
	@docker-compose ps

down:
	@echo "ðŸ›‘ Stopping all services..."
	docker-compose down
	@echo "âœ… Services stopped"

restart:
	@echo "ðŸ”„ Restarting all services..."
	docker-compose restart
	@echo "âœ… Services restarted"

logs:
	@echo "ðŸ“‹ Showing logs (Ctrl+C to exit)..."
	docker-compose logs -f --tail=100

# Start only infrastructure (PostgreSQL + Redis)
infra:
	@echo "ðŸ—ï¸ Starting infrastructure services..."
	docker-compose up -d postgres redis
	@sleep 3
	@echo "âœ… PostgreSQL & Redis started"
	@docker-compose ps postgres redis

# =============================================================================
# Database Management
# =============================================================================

# Initialize all databases (full setup)
init-db:
	@echo "ðŸŽ¯ Initializing all databases..."
	python manage_db.py init-all
	@echo "âœ… Database initialization complete"

# Create schemas manually (without Alembic)
create-schemas:
	@echo "ðŸ”§ Creating database schemas..."
	python create_schemas.py --all
	@echo "âœ… Schema creation complete"

# Show status of all databases
db-status:
	@echo "ðŸ“Š Database Status Report"
	@echo "========================"
	python manage_db.py status

# Database shell - specify DB with DB=ecommerce
DB ?= ecommerce
db-shell:
	@echo "ðŸ˜ Opening PostgreSQL shell for $(DB)..."
	@if [ "$(DB)" = "ecommerce" ]; then \
		docker exec -it app-postgres-1 psql -U scraper -d ecommerce_db; \
	elif [ "$(DB)" = "classifieds" ]; then \
		docker exec -it app-postgres-1 psql -U scraper -d classifieds_db; \
	elif [ "$(DB)" = "procurement" ]; then \
		docker exec -it app-postgres-1 psql -U scraper -d procurement_db; \
	elif [ "$(DB)" = "legacy" ]; then \
		docker exec -it app-postgres-1 psql -U scraper -d uzum_scraping; \
	else \
		echo "âŒ Invalid DB: $(DB). Use: ecommerce, classifieds, procurement, legacy"; \
		exit 1; \
	fi

# Show table counts for all databases
counts:
	@echo "ðŸ“Š Table Row Counts"
	@echo "==================="
	@echo ""
	@echo "ðŸ›’ Ecommerce Database:"
	@docker exec app-postgres-1 psql -U scraper -d ecommerce_db -c "\
		SELECT schemaname,tablename,n_tup_ins-n_tup_del as rowcount \
		FROM pg_stat_user_tables \
		ORDER BY rowcount DESC;" 2>/dev/null || echo "   Database not accessible"
	@echo ""
	@echo "ðŸª Classifieds Database:"
	@docker exec app-postgres-1 psql -U scraper -d classifieds_db -c "\
		SELECT schemaname,tablename,n_tup_ins-n_tup_del as rowcount \
		FROM pg_stat_user_tables \
		ORDER BY rowcount DESC;" 2>/dev/null || echo "   Database not accessible"
	@echo ""
	@echo "ðŸ›ï¸ Procurement Database:"
	@docker exec app-postgres-1 psql -U scraper -d procurement_db -c "\
		SELECT schemaname,tablename,n_tup_ins-n_tup_del as rowcount \
		FROM pg_stat_user_tables \
		ORDER BY rowcount DESC;" 2>/dev/null || echo "   Database not accessible"

# =============================================================================
# Migrations (Alembic)
# =============================================================================

# Run migrations for all databases
migrate-all:
	@echo "ðŸ“ Running migrations for all databases..."
	@chmod +x scripts/migrate.sh
	@./scripts/migrate.sh --all

# Migrate specific database
migrate:
ifndef DB
	@echo "âŒ Please specify database: make migrate DB=ecommerce"
	@echo "   Available: ecommerce, classifieds, procurement"
	@exit 1
endif
	@echo "ðŸ“ Migrating $(DB) database..."
	@chmod +x scripts/migrate.sh
	@./scripts/migrate.sh $(DB)

# Show migration status
migrate-status:
	@echo "ðŸ“‹ Migration Status Report"
	@echo "=========================="
	@chmod +x scripts/migrate.sh
	@./scripts/migrate.sh --status

# Create new migration (requires DB and MSG)
revision:
ifndef DB
	@echo "âŒ Please specify database: make revision DB=ecommerce MSG='Description'"
	@exit 1
endif
ifndef MSG
	@echo "âŒ Please specify message: make revision DB=ecommerce MSG='Add new indexes'"
	@exit 1
endif
	@echo "ðŸ“ Creating migration for $(DB): $(MSG)"
	@chmod +x scripts/migrate.sh
	@./scripts/migrate.sh create $(DB) "$(MSG)"

# =============================================================================
# Backup & Restore
# =============================================================================

# Backup all databases
dump-all:
	@echo "ðŸ’¾ Backing up all databases..."
	@chmod +x scripts/dump_db.sh
	@./scripts/dump_db.sh --all --compress
	@echo "âœ… Backup complete"

# Backup specific database
dump:
ifndef DB
	@echo "âŒ Please specify database: make dump DB=ecommerce"
	@echo "   Available: ecommerce, classifieds, procurement, legacy"
	@exit 1
endif
	@echo "ðŸ’¾ Backing up $(DB) database..."
	@chmod +x scripts/dump_db.sh
	@./scripts/dump_db.sh --compress $(DB)

# List available backups
list-backups:
	@echo "ðŸ“‹ Available Backups"
	@echo "===================="
	@chmod +x scripts/restore_db.sh
	@./scripts/restore_db.sh --list

# Restore specific database (requires DB and FILE)
restore:
ifndef DB
	@echo "âŒ Please specify database: make restore DB=ecommerce FILE=backup.sql"
	@exit 1
endif
ifndef FILE
	@echo "âŒ Please specify backup file: make restore DB=ecommerce FILE=backup.sql"
	@echo "   Or use: make restore DB=ecommerce FILE=latest"
	@exit 1
endif
	@echo "ðŸ”„ Restoring $(DB) from $(FILE)..."
	@chmod +x scripts/restore_db.sh
	@./scripts/restore_db.sh $(DB) $(FILE)

# Restore all databases from backup set (requires TIMESTAMP)
restore-all:
ifndef TIMESTAMP
	@echo "âŒ Please specify timestamp: make restore-all TIMESTAMP=20241208_120000"
	@exit 1
endif
	@echo "ðŸ”„ Restoring all databases from backup set: $(TIMESTAMP)"
	@chmod +x scripts/restore_db.sh
	@./scripts/restore_db.sh --all $(TIMESTAMP)

# =============================================================================
# Services
# =============================================================================

api:
	@echo "ðŸš€ Starting FastAPI server..."
	uvicorn src.api.main:app --reload --host 0.0.0.0 --port 8000

worker:
	@echo "ðŸ‘· Starting Celery worker..."
	celery -A src.workers.celery_app worker --loglevel=info --concurrency=15

beat:
	@echo "â° Starting Celery beat scheduler..."
	celery -A src.workers.celery_app beat --loglevel=info

flower:
	@echo "ðŸŒ¸ Starting Flower monitoring..."
	@echo "   Access at: http://localhost:5555"
	celery -A src.workers.celery_app flower --port=5555

# =============================================================================
# Scrapers
# =============================================================================

N ?= 100

uzum-download:
	@echo "ðŸ›’ Downloading $(N) Uzum products..."
	python -m src.platforms.uzum.downloader --target $(N)

uzex-download:
	@echo "ðŸ›ï¸ Downloading $(N) UZEX lots..."
	python -m src.platforms.uzex.downloader --type auction --target $(N)

# Continuous scrapers
continuous-uzum:
	@echo "ðŸ”„ Starting continuous Uzum scraping..."
	@echo "   This will run forever - press Ctrl+C to stop"
	celery -A src.workers.celery_app call src.workers.continuous_scraper.continuous_scan --args='["uzum"]'

continuous-uzex:
	@echo "ðŸ”„ Starting continuous UZEX scraping..."
	@echo "   This will run forever - press Ctrl+C to stop"
	celery -A src.workers.celery_app call src.workers.continuous_scraper.continuous_scan --args='["uzex"]'

# Check scraper status
scraper-status:
	@echo "ðŸ“Š Scraper Status"
	@echo "================"
	@echo ""
	@echo "ðŸ›’ Uzum Scraper:"
	@celery -A src.workers.celery_app call src.workers.continuous_scraper.check_continuous_status --args='["uzum"]' || echo "   Not running"
	@echo ""
	@echo "ðŸ›ï¸ UZEX Scraper:"
	@celery -A src.workers.celery_app call src.workers.continuous_scraper.check_continuous_status --args='["uzex"]' || echo "   Not running"

# =============================================================================
# Development
# =============================================================================

test:
	@echo "ðŸ§ª Running tests..."
	pytest tests/ -v --tb=short

lint:
	@echo "ðŸ” Running code linting..."
	@echo "Black formatting:"
	@black --check src/ || black src/
	@echo "Flake8 linting:"
	@flake8 src/ || echo "Linting issues found"

clean:
	@echo "ðŸ§¹ Cleaning temporary files..."
	@find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type f -name "*.pyo" -delete 2>/dev/null || true
	@rm -rf .pytest_cache .mypy_cache .coverage htmlcov/ 2>/dev/null || true
	@rm -rf build/ dist/ *.egg-info/ 2>/dev/null || true
	@echo "âœ… Cleanup complete"

# Create required directories
init:
	@echo "ðŸ“ Creating storage directories..."
	@mkdir -p storage/raw/uzum storage/raw/uzex storage/raw/olx backups logs
	@mkdir -p migrations/versions/ecommerce migrations/versions/classifieds migrations/versions/procurement
	@echo "âœ… Storage directories created"

# =============================================================================
# Quick Start
# =============================================================================

# Full setup for new installation
setup:
	@echo "ðŸš€ Full Platform Setup"
	@echo "======================"
	@echo ""
	@echo "1. Creating directories..."
	@make init
	@echo ""
	@echo "2. Starting infrastructure..."
	@make infra
	@echo ""
	@echo "3. Waiting for PostgreSQL..."
	@sleep 5
	@echo ""
	@echo "4. Initializing databases..."
	@make init-db
	@echo ""
	@echo "5. Showing status..."
	@make db-status
	@echo ""
	@echo "âœ… Setup complete! Platform is ready to use."
	@echo ""
	@echo "Next steps:"
	@echo "  - Start all services: make up"
	@echo "  - Start scraping: make uzum-download N=1000"
	@echo "  - View API: http://localhost:8000"
	@echo "  - Monitor workers: make flower"

# Reset everything (DANGEROUS)
reset:
	@echo "âš ï¸  This will DELETE ALL DATA and reset the platform!"
	@echo ""
	@read -p "Are you sure? Type 'reset' to confirm: " confirm && [ "$$confirm" = "reset" ] || exit 1
	@echo ""
	@echo "ðŸ—‘ï¸ Stopping services..."
	@make down || true
	@echo "ðŸ—‘ï¸ Removing containers and volumes..."
	@docker-compose down -v --remove-orphans || true
	@echo "ðŸ—‘ï¸ Cleaning directories..."
	@rm -rf storage/raw/* backups/* logs/* || true
	@echo "ðŸš€ Starting fresh setup..."
	@make setup
	@echo ""
	@echo "âœ… Platform reset complete!"

# =============================================================================
# Monitoring & Health
# =============================================================================

# Health check for all services
health:
	@echo "ðŸ¥ Health Check Report"
	@echo "====================="
	@echo ""
	@echo "ðŸ˜ PostgreSQL:"
	@docker exec app-postgres-1 pg_isready -U scraper && echo "   âœ… Healthy" || echo "   âŒ Unhealthy"
	@echo ""
	@echo "ðŸ”´ Redis:"
	@docker exec app-redis-1 redis-cli ping | grep -q PONG && echo "   âœ… Healthy" || echo "   âŒ Unhealthy"
	@echo ""
	@echo "ðŸ“Š Databases:"
	@python manage_db.py status 2>/dev/null || echo "   âŒ Cannot check database status"
	@echo ""
	@echo "ðŸ‘· Workers:"
	@docker-compose ps celery_worker | grep -q Up && echo "   âœ… Celery workers running" || echo "   âŒ Celery workers not running"

# Show resource usage
stats:
	@echo "ðŸ“Š Resource Usage"
	@echo "================="
	@echo ""
	@echo "ðŸ³ Docker Containers:"
	@docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"
	@echo ""
	@echo "ðŸ’¾ Database Sizes:"
	@docker exec app-postgres-1 psql -U scraper -d postgres -c "\
		SELECT datname as database, pg_size_pretty(pg_database_size(datname)) as size \
		FROM pg_database \
		WHERE datname IN ('ecommerce_db', 'classifieds_db', 'procurement_db', 'uzum_scraping') \
		ORDER BY pg_database_size(datname) DESC;" 2>/dev/null || echo "   Cannot access database"

# =============================================================================
# Platform Information
# =============================================================================

info:
	@echo "â„¹ï¸  Platform Information"
	@echo "========================"
	@echo ""
	@echo "ðŸ—ï¸ Architecture: Multi-Database (3 databases)"
	@echo ""
	@echo "ðŸ—„ï¸ Databases:"
	@echo "   â€¢ ecommerce_db    - B2C E-commerce (Uzum, Yandex)"
	@echo "   â€¢ classifieds_db  - C2C Classifieds (OLX)"
	@echo "   â€¢ procurement_db  - B2B Procurement (UZEX)"
	@echo ""
	@echo "ðŸ”§ Services:"
	@echo "   â€¢ PostgreSQL 17   - Primary database"
	@echo "   â€¢ Redis Alpine    - Cache & message queue"
	@echo "   â€¢ FastAPI         - REST API server"
	@echo "   â€¢ Celery          - Distributed task queue"
	@echo "   â€¢ Flower          - Task monitoring"
	@echo ""
	@echo "ðŸ“Š Current Status:"
	@docker-compose ps --format "table {{.Name}}\t{{.State}}\t{{.Ports}}"
	@echo ""
	@echo "ðŸŒ Access Points:"
	@echo "   â€¢ API:      http://localhost:8000"
	@echo "   â€¢ Flower:   http://localhost:5555"
	@echo "   â€¢ PostgreSQL: localhost:5434"
	@echo "   â€¢ Redis:    localhost:6379"

# Show this help
.DEFAULT_GOAL := help

# =============================================================================
# Real-time Monitoring (Terminal-based)
# =============================================================================

# All-in-one dashboard (recommended)
dashboard:
	@echo "ðŸŽ¯ Starting Monitoring Dashboard..."
	@python scripts/dashboard.py

# Database monitoring
monitor-db:
	@echo "ðŸ“Š Starting Database Monitor..."
	@python scripts/monitor.py

# Worker monitoring  
monitor-workers:
	@echo "ðŸ‘· Starting Worker Monitor..."
	@python scripts/monitor_workers.py

# Real-time log tailing
tail:
	@echo "ðŸ“‹ Starting Log Aggregator..."
	@chmod +x scripts/tail_logs.sh
	@./scripts/tail_logs.sh

# =============================================================================
# Debug & Testing
# =============================================================================

# Debug Yandex scraper (test mode)
debug-yandex:
	@echo "ðŸ” Running Yandex Scraper in DEBUG mode..."
	@mkdir -p logs
	@python scripts/debug_yandex.py --test --categories 3 --products 5

# Debug Yandex scraper (continuous mode)
debug-yandex-continuous:
	@echo "ðŸ”„ Running Yandex Scraper in continuous DEBUG mode..."
	@mkdir -p logs
	@python scripts/debug_yandex.py --continuous

# Debug Uzum scraper
debug-uzum:
	@echo "ðŸ” Running Uzum Scraper in DEBUG mode..."
	@mkdir -p logs
	@python -m src.platforms.uzum.downloader --target 100 2>&1 | tee logs/uzum_debug_$$(date +%Y%m%d_%H%M%S).log

# Debug UZEX scraper
debug-uzex:
	@echo "ðŸ” Running UZEX Scraper in DEBUG mode..."
	@mkdir -p logs
	@python -m src.platforms.uzex.downloader --type auction --target 20 2>&1 | tee logs/uzex_debug_$$(date +%Y%m%d_%H%M%S).log

# View latest debug log
view-log:
	@echo "ðŸ“‹ Latest debug logs:"
	@ls -lt logs/*.log 2>/dev/null | head -5 || echo "No logs found"

# Quick table counts
quick-counts:
	@docker compose exec -T postgres psql -U scraper -d uzum_scraping -c "SELECT 'products' as tbl, COUNT(*) FROM products UNION ALL SELECT 'skus', COUNT(*) FROM skus UNION ALL SELECT 'sellers', COUNT(*) FROM sellers UNION ALL SELECT 'uzex_lots', COUNT(*) FROM uzex_lots;"

# Celery status
celery-status:
	@celery -A src.workers.celery_app inspect ping 2>/dev/null || echo "Workers offline"
	@celery -A src.workers.celery_app inspect active 2>/dev/null | head -10

# Redis checkpoints
checkpoints:
	@docker compose exec -T redis redis-cli KEYS 'checkpoint:*' 2>/dev/null || echo "Redis not accessible"

# Debug all platforms
debug-all:
	@make debug-uzum
	@make debug-yandex
	@make debug-uzex
