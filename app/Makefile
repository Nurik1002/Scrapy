# Marketplace Analytics Platform - Multi-Database Makefile
# ========================================================
# Supports three-database architecture:
# - ecommerce_db: B2C platforms (Uzum, Yandex)
# - classifieds_db: C2C platforms (OLX)
# - procurement_db: B2B platforms (UZEX)

.PHONY: help up down restart logs db-shell api worker beat flower \
        migrate migrate-all migrate-status create-schemas dump dump-all restore \
        counts uzum-download uzex-download test clean init-db db-status

# Default target
help:
	@echo "Marketplace Analytics Platform - Multi-Database Architecture"
	@echo "============================================================="
	@echo ""
	@echo "üöÄ Docker Commands:"
	@echo "  make up              - Start all services"
	@echo "  make down            - Stop all services"
	@echo "  make restart         - Restart all services"
	@echo "  make logs            - View logs (tail -f)"
	@echo "  make infra           - Start only PostgreSQL & Redis"
	@echo ""
	@echo "üóÑÔ∏è Database Management:"
	@echo "  make init-db         - Initialize all databases (create + migrate + setup)"
	@echo "  make create-schemas  - Create database schemas manually"
	@echo "  make db-status       - Show status of all databases"
	@echo "  make db-shell DB=ecommerce - PostgreSQL shell for specific database"
	@echo "  make counts          - Show table row counts for all databases"
	@echo ""
	@echo "üìù Migrations (Alembic):"
	@echo "  make migrate-all     - Run migrations for all databases"
	@echo "  make migrate DB=ecommerce - Migrate specific database"
	@echo "  make migrate-status  - Show migration status for all databases"
	@echo "  make revision DB=ecommerce MSG='Add indexes' - Create new migration"
	@echo ""
	@echo "üíæ Backup & Restore:"
	@echo "  make dump-all        - Backup all databases"
	@echo "  make dump DB=ecommerce - Backup specific database"
	@echo "  make restore DB=ecommerce FILE=backup.sql - Restore database"
	@echo "  make restore-all TIMESTAMP=20241208_120000 - Restore all from backup set"
	@echo ""
	@echo "üîß Services:"
	@echo "  make api             - Start FastAPI only"
	@echo "  make worker          - Start Celery worker"
	@echo "  make beat            - Start Celery beat scheduler"
	@echo "  make flower          - Start Flower (monitoring)"
	@echo ""
	@echo "üìä Scrapers:"
	@echo "  make uzum-download N=1000    - Download N Uzum products"
	@echo "  make uzex-download N=100     - Download N UZEX lots"
	@echo "  make continuous-uzum         - Start continuous Uzum scraping"
	@echo "  make continuous-uzex         - Start continuous UZEX scraping"
	@echo ""
	@echo "üß™ Development:"
	@echo "  make test            - Run tests"
	@echo "  make clean           - Remove temp files"
	@echo "  make lint            - Run code linting"
	@echo ""
	@echo "Database Options: ecommerce, classifieds, procurement, legacy"

# =============================================================================
# Docker Commands
# =============================================================================

up:
	@echo "üöÄ Starting all services..."
	docker-compose up -d
	@echo "‚úÖ Services started"
	@docker-compose ps

down:
	@echo "üõë Stopping all services..."
	docker-compose down
	@echo "‚úÖ Services stopped"

restart:
	@echo "üîÑ Restarting all services..."
	docker-compose restart
	@echo "‚úÖ Services restarted"

logs:
	@echo "üìã Showing logs (Ctrl+C to exit)..."
	docker-compose logs -f --tail=100

# Start only infrastructure (PostgreSQL + Redis)
infra:
	@echo "üèóÔ∏è Starting infrastructure services..."
	docker-compose up -d postgres redis
	@sleep 3
	@echo "‚úÖ PostgreSQL & Redis started"
	@docker-compose ps postgres redis

# =============================================================================
# Database Management
# =============================================================================

# Initialize all databases (full setup)
init-db:
	@echo "üéØ Initializing all databases..."
	python manage_db.py init-all
	@echo "‚úÖ Database initialization complete"

# Create schemas manually (without Alembic)
create-schemas:
	@echo "üîß Creating database schemas..."
	python create_schemas.py --all
	@echo "‚úÖ Schema creation complete"

# Show status of all databases
db-status:
	@echo "üìä Database Status Report"
	@echo "========================"
	python manage_db.py status

# Database shell - specify DB with DB=ecommerce
DB ?= ecommerce
db-shell:
	@echo "üêò Opening PostgreSQL shell for $(DB)..."
	@if [ "$(DB)" = "ecommerce" ]; then \
		docker exec -it app-postgres-1 psql -U scraper -d ecommerce_db; \
	elif [ "$(DB)" = "classifieds" ]; then \
		docker exec -it app-postgres-1 psql -U scraper -d classifieds_db; \
	elif [ "$(DB)" = "procurement" ]; then \
		docker exec -it app-postgres-1 psql -U scraper -d procurement_db; \
	elif [ "$(DB)" = "legacy" ]; then \
		docker exec -it app-postgres-1 psql -U scraper -d uzum_scraping; \
	else \
		echo "‚ùå Invalid DB: $(DB). Use: ecommerce, classifieds, procurement, legacy"; \
		exit 1; \
	fi

# Show table counts for all databases
counts:
	@echo "üìä Table Row Counts"
	@echo "==================="
	@echo ""
	@echo "üõí Ecommerce Database:"
	@docker exec app-postgres-1 psql -U scraper -d ecommerce_db -c "\
		SELECT schemaname,tablename,n_tup_ins-n_tup_del as rowcount \
		FROM pg_stat_user_tables \
		ORDER BY rowcount DESC;" 2>/dev/null || echo "   Database not accessible"
	@echo ""
	@echo "üè™ Classifieds Database:"
	@docker exec app-postgres-1 psql -U scraper -d classifieds_db -c "\
		SELECT schemaname,tablename,n_tup_ins-n_tup_del as rowcount \
		FROM pg_stat_user_tables \
		ORDER BY rowcount DESC;" 2>/dev/null || echo "   Database not accessible"
	@echo ""
	@echo "üèõÔ∏è Procurement Database:"
	@docker exec app-postgres-1 psql -U scraper -d procurement_db -c "\
		SELECT schemaname,tablename,n_tup_ins-n_tup_del as rowcount \
		FROM pg_stat_user_tables \
		ORDER BY rowcount DESC;" 2>/dev/null || echo "   Database not accessible"

# =============================================================================
# Migrations (Alembic)
# =============================================================================

# Run migrations for all databases
migrate-all:
	@echo "üìù Running migrations for all databases..."
	@chmod +x scripts/migrate.sh
	@./scripts/migrate.sh --all

# Migrate specific database
migrate:
ifndef DB
	@echo "‚ùå Please specify database: make migrate DB=ecommerce"
	@echo "   Available: ecommerce, classifieds, procurement"
	@exit 1
endif
	@echo "üìù Migrating $(DB) database..."
	@chmod +x scripts/migrate.sh
	@./scripts/migrate.sh $(DB)

# Show migration status
migrate-status:
	@echo "üìã Migration Status Report"
	@echo "=========================="
	@chmod +x scripts/migrate.sh
	@./scripts/migrate.sh --status

# Create new migration (requires DB and MSG)
revision:
ifndef DB
	@echo "‚ùå Please specify database: make revision DB=ecommerce MSG='Description'"
	@exit 1
endif
ifndef MSG
	@echo "‚ùå Please specify message: make revision DB=ecommerce MSG='Add new indexes'"
	@exit 1
endif
	@echo "üìù Creating migration for $(DB): $(MSG)"
	@chmod +x scripts/migrate.sh
	@./scripts/migrate.sh create $(DB) "$(MSG)"

# =============================================================================
# Backup & Restore
# =============================================================================

# Backup all databases
dump-all:
	@echo "üíæ Backing up all databases..."
	@chmod +x scripts/dump_db.sh
	@./scripts/dump_db.sh --all --compress
	@echo "‚úÖ Backup complete"

# Backup specific database
dump:
ifndef DB
	@echo "‚ùå Please specify database: make dump DB=ecommerce"
	@echo "   Available: ecommerce, classifieds, procurement, legacy"
	@exit 1
endif
	@echo "üíæ Backing up $(DB) database..."
	@chmod +x scripts/dump_db.sh
	@./scripts/dump_db.sh --compress $(DB)

# List available backups
list-backups:
	@echo "üìã Available Backups"
	@echo "===================="
	@chmod +x scripts/restore_db.sh
	@./scripts/restore_db.sh --list

# Restore specific database (requires DB and FILE)
restore:
ifndef DB
	@echo "‚ùå Please specify database: make restore DB=ecommerce FILE=backup.sql"
	@exit 1
endif
ifndef FILE
	@echo "‚ùå Please specify backup file: make restore DB=ecommerce FILE=backup.sql"
	@echo "   Or use: make restore DB=ecommerce FILE=latest"
	@exit 1
endif
	@echo "üîÑ Restoring $(DB) from $(FILE)..."
	@chmod +x scripts/restore_db.sh
	@./scripts/restore_db.sh $(DB) $(FILE)

# Restore all databases from backup set (requires TIMESTAMP)
restore-all:
ifndef TIMESTAMP
	@echo "‚ùå Please specify timestamp: make restore-all TIMESTAMP=20241208_120000"
	@exit 1
endif
	@echo "üîÑ Restoring all databases from backup set: $(TIMESTAMP)"
	@chmod +x scripts/restore_db.sh
	@./scripts/restore_db.sh --all $(TIMESTAMP)

# =============================================================================
# Services
# =============================================================================

api:
	@echo "üöÄ Starting FastAPI server..."
	uvicorn src.api.main:app --reload --host 0.0.0.0 --port 8000

worker:
	@echo "üë∑ Starting Celery worker..."
	celery -A src.workers.celery_app worker --loglevel=info --concurrency=15

beat:
	@echo "‚è∞ Starting Celery beat scheduler..."
	celery -A src.workers.celery_app beat --loglevel=info

flower:
	@echo "üå∏ Starting Flower monitoring..."
	@echo "   Access at: http://localhost:5555"
	celery -A src.workers.celery_app flower --port=5555

# =============================================================================
# Scrapers
# =============================================================================

N ?= 100

uzum-download:
	@echo "üõí Downloading $(N) Uzum products..."
	python -m src.platforms.uzum.downloader --target $(N)

uzex-download:
	@echo "üèõÔ∏è Downloading $(N) UZEX lots..."
	python -m src.platforms.uzex.downloader --type auction --target $(N)

# Continuous scrapers
continuous-uzum:
	@echo "üîÑ Starting continuous Uzum scraping..."
	@echo "   This will run forever - press Ctrl+C to stop"
	celery -A src.workers.celery_app call src.workers.continuous_scraper.continuous_scan --args='["uzum"]'

continuous-uzex:
	@echo "üîÑ Starting continuous UZEX scraping..."
	@echo "   This will run forever - press Ctrl+C to stop"
	celery -A src.workers.celery_app call src.workers.continuous_scraper.continuous_scan --args='["uzex"]'

# Check scraper status
scraper-status:
	@echo "üìä Scraper Status"
	@echo "================"
	@echo ""
	@echo "üõí Uzum Scraper:"
	@celery -A src.workers.celery_app call src.workers.continuous_scraper.check_continuous_status --args='["uzum"]' || echo "   Not running"
	@echo ""
	@echo "üèõÔ∏è UZEX Scraper:"
	@celery -A src.workers.celery_app call src.workers.continuous_scraper.check_continuous_status --args='["uzex"]' || echo "   Not running"

# =============================================================================
# Development
# =============================================================================

test:
	@echo "üß™ Running tests..."
	pytest tests/ -v --tb=short

lint:
	@echo "üîç Running code linting..."
	@echo "Black formatting:"
	@black --check src/ || black src/
	@echo "Flake8 linting:"
	@flake8 src/ || echo "Linting issues found"

clean:
	@echo "üßπ Cleaning temporary files..."
	@find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type f -name "*.pyo" -delete 2>/dev/null || true
	@rm -rf .pytest_cache .mypy_cache .coverage htmlcov/ 2>/dev/null || true
	@rm -rf build/ dist/ *.egg-info/ 2>/dev/null || true
	@echo "‚úÖ Cleanup complete"

# Create required directories
init:
	@echo "üìÅ Creating storage directories..."
	@mkdir -p storage/raw/uzum storage/raw/uzex storage/raw/olx backups logs
	@mkdir -p migrations/versions/ecommerce migrations/versions/classifieds migrations/versions/procurement
	@echo "‚úÖ Storage directories created"

# =============================================================================
# Quick Start
# =============================================================================

# Full setup for new installation
setup:
	@echo "üöÄ Full Platform Setup"
	@echo "======================"
	@echo ""
	@echo "1. Creating directories..."
	@make init
	@echo ""
	@echo "2. Starting infrastructure..."
	@make infra
	@echo ""
	@echo "3. Waiting for PostgreSQL..."
	@sleep 5
	@echo ""
	@echo "4. Initializing databases..."
	@make init-db
	@echo ""
	@echo "5. Showing status..."
	@make db-status
	@echo ""
	@echo "‚úÖ Setup complete! Platform is ready to use."
	@echo ""
	@echo "Next steps:"
	@echo "  - Start all services: make up"
	@echo "  - Start scraping: make uzum-download N=1000"
	@echo "  - View API: http://localhost:8000"
	@echo "  - Monitor workers: make flower"

# Reset everything (DANGEROUS)
reset:
	@echo "‚ö†Ô∏è  This will DELETE ALL DATA and reset the platform!"
	@echo ""
	@read -p "Are you sure? Type 'reset' to confirm: " confirm && [ "$$confirm" = "reset" ] || exit 1
	@echo ""
	@echo "üóëÔ∏è Stopping services..."
	@make down || true
	@echo "üóëÔ∏è Removing containers and volumes..."
	@docker-compose down -v --remove-orphans || true
	@echo "üóëÔ∏è Cleaning directories..."
	@rm -rf storage/raw/* backups/* logs/* || true
	@echo "üöÄ Starting fresh setup..."
	@make setup
	@echo ""
	@echo "‚úÖ Platform reset complete!"

# =============================================================================
# Monitoring & Health
# =============================================================================

# Health check for all services
health:
	@echo "üè• Health Check Report"
	@echo "====================="
	@echo ""
	@echo "üêò PostgreSQL:"
	@docker exec app-postgres-1 pg_isready -U scraper && echo "   ‚úÖ Healthy" || echo "   ‚ùå Unhealthy"
	@echo ""
	@echo "üî¥ Redis:"
	@docker exec app-redis-1 redis-cli ping | grep -q PONG && echo "   ‚úÖ Healthy" || echo "   ‚ùå Unhealthy"
	@echo ""
	@echo "üìä Databases:"
	@python manage_db.py status 2>/dev/null || echo "   ‚ùå Cannot check database status"
	@echo ""
	@echo "üë∑ Workers:"
	@docker-compose ps celery_worker | grep -q Up && echo "   ‚úÖ Celery workers running" || echo "   ‚ùå Celery workers not running"

# Show resource usage
stats:
	@echo "üìä Resource Usage"
	@echo "================="
	@echo ""
	@echo "üê≥ Docker Containers:"
	@docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"
	@echo ""
	@echo "üíæ Database Sizes:"
	@docker exec app-postgres-1 psql -U scraper -d postgres -c "\
		SELECT datname as database, pg_size_pretty(pg_database_size(datname)) as size \
		FROM pg_database \
		WHERE datname IN ('ecommerce_db', 'classifieds_db', 'procurement_db', 'uzum_scraping') \
		ORDER BY pg_database_size(datname) DESC;" 2>/dev/null || echo "   Cannot access database"

# =============================================================================
# Platform Information
# =============================================================================

info:
	@echo "‚ÑπÔ∏è  Platform Information"
	@echo "========================"
	@echo ""
	@echo "üèóÔ∏è Architecture: Multi-Database (3 databases)"
	@echo ""
	@echo "üóÑÔ∏è Databases:"
	@echo "   ‚Ä¢ ecommerce_db    - B2C E-commerce (Uzum, Yandex)"
	@echo "   ‚Ä¢ classifieds_db  - C2C Classifieds (OLX)"
	@echo "   ‚Ä¢ procurement_db  - B2B Procurement (UZEX)"
	@echo ""
	@echo "üîß Services:"
	@echo "   ‚Ä¢ PostgreSQL 17   - Primary database"
	@echo "   ‚Ä¢ Redis Alpine    - Cache & message queue"
	@echo "   ‚Ä¢ FastAPI         - REST API server"
	@echo "   ‚Ä¢ Celery          - Distributed task queue"
	@echo "   ‚Ä¢ Flower          - Task monitoring"
	@echo ""
	@echo "üìä Current Status:"
	@docker-compose ps --format "table {{.Name}}\t{{.State}}\t{{.Ports}}"
	@echo ""
	@echo "üåê Access Points:"
	@echo "   ‚Ä¢ API:      http://localhost:8000"
	@echo "   ‚Ä¢ Flower:   http://localhost:5555"
	@echo "   ‚Ä¢ PostgreSQL: localhost:5434"
	@echo "   ‚Ä¢ Redis:    localhost:6379"

# Show this help
.DEFAULT_GOAL := help
